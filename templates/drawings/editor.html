{% extends 'base.html' %}
{% load static %}

{% block title %}Editor - {{ project.name }}{% endblock %}

{% block extra_css %}
<style>
    /* Hide the full-width navbar on the editor page */
    .navbar { display: none; }

    .editor-container {
        display: flex;
        height: 100vh;
    }

    /* Left Sidebar - Tools */
    .sidebar-left {
        width: 300px;
        background: white;
        border-right: 1px solid #ddd;
        padding: 1rem;
        overflow-y: auto;
        transition: width 0.2s, padding 0.2s;
        position: relative;
        flex-shrink: 0;
    }
    .sidebar-left.collapsed {
        width: 40px;
        padding: 0.4rem 0.25rem;
        overflow: hidden;
    }
    .sidebar-left.collapsed .tool-section { display: none; }
    .sidebar-left.collapsed .sidebar-toggle { display: flex; }

    .tool-section {
        margin-bottom: 1.5rem;
    }

    .tool-section h4 {
        font-size: 0.85rem;
        text-transform: uppercase;
        color: #6c757d;
        margin-bottom: 0.75rem;
        letter-spacing: 0.5px;
    }

    .tool-btn {
        display: block;
        width: 100%;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        background: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        text-align: left;
        transition: all 0.2s;
    }

    .tool-btn:hover {
        background: #e9ecef;
    }

    .tool-btn.active {
        background: #3498db;
        color: white;
        border-color: #3498db;
    }

    /* Main Canvas Area */
    .canvas-area {
        flex: 1;
        background: #e0e0e0;
        position: relative;
        overflow: hidden;
    }

    #canvas-container {
        width: 100%;
        height: 100%;
        cursor: grab;
    }

    #canvas-container.dragging {
        cursor: grabbing;
    }

    /* Right Sidebar - Properties */
    .sidebar-right {
        width: 300px;
        background: white;
        border-left: 1px solid #ddd;
        padding: 1rem;
        overflow-y: auto;
        transition: width 0.2s, padding 0.2s, border 0.2s;
        position: relative;
        flex-shrink: 0;
    }
    .sidebar-right.collapsed {
        width: 0;
        padding: 0;
        border: none;
        overflow: hidden;
    }

    .property-group {
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #eee;
    }

    .property-group label {
        display: block;
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }

    .property-group input {
        width: 100%;
        padding: 0.4rem;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    /* Bottom Toolbar */
    .bottom-toolbar {
        position: absolute;
        bottom: 1rem;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .zoom-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .zoom-controls button {
        width: 30px;
        height: 30px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
    }

    .zoom-controls button:hover {
        background: #f8f9fa;
    }

    /* Sheet Layers Panel */
    .layer-item {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 4px;
        margin-bottom: 0.5rem;
        cursor: pointer;
    }

    .layer-item:hover {
        background: #e9ecef;
    }

    .layer-item.selected {
        background: #d4edda;
        border: 1px solid #28a745;
    }

    .layer-visibility {
        margin-right: 0.5rem;
    }

    /* Asset List */
    .asset-item {
        padding: 0.5rem;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .asset-item:hover {
        background: #f8f9fa;
    }

    .asset-item.adjusted {
        background: #fff3cd;
    }

    .coordinates {
        font-size: 0.75rem;
        color: #6c757d;
    }

    /* Status bar */
    .status-bar {
        position: absolute;
        top: 1rem;
        left: 10px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        font-size: 0.85rem;
    }

    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
    }

    .modal-content {
        background: white;
        max-width: 500px;
        margin: 100px auto;
        padding: 2rem;
        border-radius: 8px;
    }

    /* Tabs */
    .tabs {
        display: flex;
        border-bottom: 1px solid #ddd;
        margin-bottom: 1rem;
    }

    .tab {
        padding: 0.5rem 1rem;
        cursor: pointer;
        border-bottom: 2px solid transparent;
    }

    .tab.active {
        border-bottom-color: #3498db;
        color: #3498db;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* Sidebar toggle buttons */
    .sidebar-toggle {
        width: 28px;
        height: 28px;
        border: 1px solid #ddd;
        background: #f8f9fa;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        color: #555;
        flex-shrink: 0;
        margin-bottom: 0.5rem;
    }
    .sidebar-toggle:hover { background: #e9ecef; }

    /* Right sidebar toggle floats on the canvas edge */
    .right-toggle-btn {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        z-index: 10;
    }

    /* Import batch list styles */
    .batch-item {
        padding: 0.4rem 0.5rem;
        background: #f8f9fa;
        border-radius: 4px;
        margin-bottom: 0.4rem;
        font-size: 0.85rem;
    }
    .batch-item .batch-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .batch-item .batch-name {
        font-weight: 500;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex: 1;
    }
    .batch-item .batch-count {
        color: #6c757d;
        font-size: 0.8rem;
        margin-left: 0.5rem;
    }
    .batch-delete-btn {
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        padding: 0 0.25rem;
        font-size: 0.9rem;
        opacity: 0.6;
    }
    .batch-delete-btn:hover { opacity: 1; }
    .asset-delete-btn {
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        padding: 0 0.25rem;
        font-size: 0.75rem;
        opacity: 0.5;
        float: right;
    }
    .asset-delete-btn:hover { opacity: 1; }
</style>
{% endblock %}

{% block content %}
<div class="editor-container">
    <!-- Left Sidebar - Tools -->
    <div class="sidebar-left" id="sidebar-left">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <a href="{% url 'drawings:project_list' %}" style="font-size: 0.8rem; color: #3498db; text-decoration: none;">&larr; Projects</a>
            <span style="font-size: 0.8rem; font-weight: 600; color: #2c3e50; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 180px;" title="{{ project.name }}">{{ project.name }}</span>
            <button class="sidebar-toggle" onclick="toggleLeftSidebar()" title="Toggle sidebar" style="margin: 0;">&laquo;</button>
        </div>
        <div class="tool-section">
            <h4>Mode</h4>
            <button class="tool-btn active" data-mode="pan" onclick="setMode('pan')">
                ‚úã Pan & Zoom
            </button>
            <button class="tool-btn" data-mode="select" onclick="setMode('select')">
                ‚û§ Select
            </button>
            <button class="tool-btn" data-mode="crop" onclick="setMode('crop')">
                ‚úÇ Cut Line
            </button>
            <button class="tool-btn" onclick="flipSelectedSheetCut()" style="font-size: 0.85em;">
                ‚ü≤ Flip Cut Side
            </button>
            <button class="tool-btn" onclick="clearSelectedSheetCut()" style="font-size: 0.85em;">
                ‚Ü© Clear Cut
            </button>
            <button class="tool-btn" data-mode="split" onclick="setMode('split')">
                ‚´Ω Split Sheet
            </button>
            <button class="tool-btn" data-mode="calibrate" onclick="setMode('calibrate')">
                üìè Calibrate Scale
            </button>
            <button class="tool-btn" data-mode="origin" onclick="setMode('origin')">
                ‚äï Set Origin
            </button>
            <button class="tool-btn" data-mode="measure" onclick="toggleMeasurePanel()">
                üìê Measure
            </button>
            <div id="measure-panel" style="display: none; margin-top: 0.5rem; padding: 0.5rem; background: #f0f7ff; border: 1px solid #bee0ff; border-radius: 4px;">
                <div id="measure-scale-warning" style="display: none; margin-bottom: 0.5rem; padding: 0.4rem; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; font-size: 0.8rem; color: #856404;">
                    Scale not calibrated. Distances shown in pixels only.
                </div>
                <div style="margin-bottom: 0.5rem;">
                    <label style="font-size: 0.8rem; color: #6c757d;">Measurement Type</label>
                    <div style="display: flex; gap: 0.75rem; margin-top: 0.25rem;">
                        <label style="font-size: 0.85rem; font-weight: normal; cursor: pointer;">
                            <input type="radio" name="measure-type" value="single" checked
                                   onchange="toggleMeasureMode('single')"> Single
                        </label>
                        <label style="font-size: 0.85rem; font-weight: normal; cursor: pointer;">
                            <input type="radio" name="measure-type" value="chain"
                                   onchange="toggleMeasureMode('chain')"> Chain
                        </label>
                    </div>
                </div>
                <div id="measure-segments" style="max-height: 120px; overflow-y: auto; margin-bottom: 0.5rem;"></div>
                <div style="display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 600; padding: 0.3rem 0; border-top: 1px solid #bee0ff;">
                    <span>Total:</span>
                    <span id="measure-total">--</span>
                </div>
                <div id="measure-straight-row" style="display: none; justify-content: space-between; font-size: 0.85rem; color: #6c757d; padding: 0.2rem 0;">
                    <span>Straight line:</span>
                    <span id="measure-straight">--</span>
                </div>
                <button class="tool-btn" style="margin-top: 0.5rem; font-size: 0.85em; text-align: center; width: 100%;"
                        onclick="clearMeasurements()">
                    Clear Measurements
                </button>
            </div>
        </div>

        <div class="tool-section">
            <h4>View Rotation</h4>
            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                <button class="tool-btn" style="flex: 1; text-align: center;" onclick="rotateViewportBy(-90)">-90</button>
                <button class="tool-btn" style="flex: 1; text-align: center;" onclick="rotateViewportBy(-15)">-15</button>
                <button class="tool-btn" style="flex: 1; text-align: center;" onclick="rotateViewportBy(15)">+15</button>
                <button class="tool-btn" style="flex: 1; text-align: center;" onclick="rotateViewportBy(90)">+90</button>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <input type="number" id="viewport-rotation" value="0" step="1" style="flex: 1; padding: 0.4rem; border: 1px solid #ddd; border-radius: 4px;" onchange="setViewportRotation(parseFloat(this.value) || 0)">
                <span style="font-size: 0.85rem; color: #6c757d;">deg</span>
                <button class="tool-btn" style="width: auto; margin: 0; padding: 0.4rem 0.75rem;" onclick="setViewportRotation(0)">Reset</button>
            </div>
        </div>

        <div class="tool-section">
            <h4>Sheets</h4>
            <div id="sheet-layers"></div>
            <button class="btn" style="width: 100%; margin-top: 0.5rem;" onclick="showUploadModal()">
                + Add Sheet
            </button>
        </div>

        <div class="tool-section">
            <h4>Assets</h4>
            <input type="text" id="asset-search-left" placeholder="Search assets..."
                   style="width: 100%; padding: 0.3rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; margin-bottom: 0.5rem;">
            <div id="import-batches"></div>
            <button class="btn" style="width: 100%;" onclick="showImportModal()">
                Import CSV
            </button>
            <button class="tool-btn" style="margin-top: 0.5rem;" onclick="toggleVerifyPanel()">
                Verify & Plot
            </button>
            <div id="verify-panel" style="display: none; margin-top: 0.5rem; padding: 0.5rem; background: #f0f7ff; border: 1px solid #bee0ff; border-radius: 4px;">
                <div id="verify-scale-warning" style="display: none; margin-bottom: 0.5rem; padding: 0.4rem; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; font-size: 0.8rem; color: #856404;">
                    Scale not calibrated. Use the Scale tool first for accurate placement.
                </div>
                <div style="margin-bottom: 0.5rem;">
                    <label style="font-size: 0.8rem; color: #6c757d;">Coordinate Unit</label>
                    <select id="verify-coord-unit" style="width: 100%; padding: 0.3rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem;"
                            onchange="onCoordUnitChange(this.value)">
                        <option value="meters">Meters</option>
                        <option value="degrees">Lat/Lon Degrees (WGS84)</option>
                        <option value="gda94_geo">GDA94 Geographic (Lat/Lon)</option>
                        <option value="gda94_mga">GDA94 MGA (Easting/Northing)</option>
                    </select>
                </div>
                <div style="margin-bottom: 0.5rem;">
                    <label style="font-size: 0.8rem; color: #6c757d;">Reference Asset</label>
                    <input type="text" id="verify-asset-search" placeholder="Search assets..."
                           style="width: 100%; padding: 0.3rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; margin-bottom: 0.3rem; box-sizing: border-box;"
                           oninput="filterVerifyAssetSelect(this.value)"
                           onfocus="expandVerifyAssetList()"
                           >
                    <select id="verify-asset-select" size="1"
                            style="width: 100%; padding: 0.3rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; transition: height 0.25s ease; overflow-y: auto;"
                            onchange="onVerifyAssetSelected()"
                            onfocus="expandVerifyAssetList()">
                        <option value="">-- Select --</option>
                    </select>
                </div>
                <div id="verify-ref-info" style="display: none; margin-bottom: 0.5rem; padding: 0.4rem; background: #f8f9fa; border-radius: 4px; font-size: 0.8rem;">
                    <strong>Coords:</strong> <span id="verify-ref-coords"></span><br>
                    <span id="verify-ref-placed" style="color: #6c757d;">Click map to set location</span>
                </div>
                <div style="margin-bottom: 0.5rem;">
                    <label style="font-size: 0.8rem; color: #6c757d;">Rotation</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="range" id="verify-rotation-slider" min="0" max="360" value="0" step="1" style="flex: 1;"
                               oninput="onVerifyRotationChange(parseFloat(this.value))">
                        <input type="number" id="verify-rotation-input" value="0" step="1"
                               style="width: 55px; padding: 0.3rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem;"
                               onchange="onVerifyRotationChange(parseFloat(this.value) || 0)">
                    </div>
                </div>
                <button class="btn btn-success" style="width: 100%; font-size: 0.85rem;" onclick="applyVerification()">Apply & Plot All</button>
            </div>
            <div style="margin-top: 0.5rem;">
                <label style="font-size: 0.85rem; color: #6c757d;">Asset Rotation</label>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <input type="range" id="asset-rotation-slider" min="0" max="360" value="0" style="flex: 1;"
                           oninput="setAssetRotation(parseFloat(this.value))">
                    <input type="number" id="asset-rotation-input" value="0" step="1"
                           style="width: 60px; padding: 0.4rem; border: 1px solid #ddd; border-radius: 4px;"
                           onchange="setAssetRotation(parseFloat(this.value) || 0)">
                    <span style="font-size: 0.85rem; color: #6c757d;">deg</span>
                </div>
            </div>
        </div>

        <div class="tool-section">
            <h4>Export</h4>
            <button class="btn btn-success" style="width: 100%;" onclick="exportProject()">
                üì§ Export PDFs
            </button>
            <button class="btn" style="width: 100%; margin-top: 0.5rem;" onclick="downloadReport()">
                üìä Adjustment Report
            </button>
        </div>
    </div>

    <!-- Main Canvas Area -->
    <div class="canvas-area">
        <button class="sidebar-toggle right-toggle-btn" onclick="toggleRightSidebar()" title="Toggle properties panel">&raquo;</button>
        <div id="canvas-container"></div>

        <div class="status-bar" id="status-bar">
            Mode: <span id="current-mode">Pan</span> |
            Zoom: <span id="zoom-level">100</span>% |
            Rotation: <span id="rotation-level">0</span>¬∞ |
            Position: <span id="cursor-position">0, 0</span>
        </div>

        <div class="bottom-toolbar">
            <div class="zoom-controls">
                <button onclick="zoomOut()">‚àí</button>
                <span id="zoom-display">100%</span>
                <button onclick="zoomIn()">+</button>
                <button onclick="zoomFit()">Fit</button>
            </div>
            <button class="btn" onclick="resetView()">Reset View</button>
        </div>
    </div>

    <!-- Right Sidebar - Properties -->
    <div class="sidebar-right" id="sidebar-right">
        <div class="tabs">
            <div class="tab active" data-tab="properties" onclick="showTab('properties')">Properties</div>
            <div class="tab" data-tab="assets" onclick="showTab('assets')">Assets</div>
        </div>

        <div id="properties-tab" class="tab-content active">
            <div id="no-selection" style="color: #6c757d; text-align: center; padding: 2rem;">
                Select a sheet or asset to view properties
            </div>

            <div id="sheet-properties" style="display: none;">
                <h4 style="margin-bottom: 1rem;">Sheet Properties</h4>
                <div class="property-group">
                    <label>Name</label>
                    <input type="text" id="sheet-name" onchange="updateSheetProperty('name', this.value)">
                </div>
                <div class="property-group">
                    <label>Offset X (px)</label>
                    <input type="number" id="sheet-offset-x" onchange="updateSheetProperty('offset_x', this.value)">
                </div>
                <div class="property-group">
                    <label>Offset Y (px)</label>
                    <input type="number" id="sheet-offset-y" onchange="updateSheetProperty('offset_y', this.value)">
                </div>
                <div class="property-group">
                    <label>Rotation (deg)</label>
                    <input type="number" id="sheet-rotation" onchange="updateSheetProperty('rotation', this.value)">
                </div>
                <div class="property-group">
                    <label>Z-Index (layer order)</label>
                    <input type="number" id="sheet-zindex" onchange="updateSheetProperty('z_index', this.value)">
                </div>
                <button class="btn" style="width: 100%; margin-top: 1rem; background: #dc3545; color: white;" onclick="deleteSelectedSheet()">
                    Delete Sheet
                </button>
            </div>

            <div id="asset-properties" style="display: none;">
                <h4 style="margin-bottom: 1rem;">Asset Properties</h4>
                <div class="property-group">
                    <label>Asset ID</label>
                    <input type="text" id="asset-id" readonly>
                </div>
                <div class="property-group">
                    <label>Name</label>
                    <input type="text" id="asset-name" readonly>
                </div>
                <div class="property-group">
                    <label>Original X (m)</label>
                    <input type="number" id="asset-orig-x" readonly>
                </div>
                <div class="property-group">
                    <label>Original Y (m)</label>
                    <input type="number" id="asset-orig-y" readonly>
                </div>
                <div class="property-group">
                    <label>Adjusted X (m)</label>
                    <input type="number" id="asset-adj-x" step="0.01" onchange="updateAssetPosition()">
                </div>
                <div class="property-group">
                    <label>Adjusted Y (m)</label>
                    <input type="number" id="asset-adj-y" step="0.01" onchange="updateAssetPosition()">
                </div>
                <div class="property-group">
                    <label>Notes</label>
                    <textarea id="asset-notes" rows="2"></textarea>
                </div>
                <button class="btn btn-success" style="width: 100%;" onclick="saveAssetAdjustment()">
                    Save Adjustment
                </button>
            </div>
        </div>

        <div id="assets-tab" class="tab-content">
            <div style="margin-bottom: 1rem;">
                <input type="text" id="asset-search" placeholder="Search assets..." style="width: 100%;">
            </div>
            <div id="asset-list" style="max-height: 500px; overflow-y: auto;"></div>
        </div>
    </div>
</div>

<!-- Upload Sheet Modal -->
<div id="uploadModal" class="modal">
    <div class="modal-content">
        <h2 style="margin-bottom: 1rem;">Upload PDF Sheet</h2>
        <p class="text-muted" style="margin-bottom: 1rem; font-size: 0.9rem;">
            Multi-page PDFs will automatically create separate sheets for each page,<br>
            named sequentially (e.g., name-01, name-02, ...).
        </p>
        <form id="uploadForm" enctype="multipart/form-data">
            <div class="form-group">
                <label>Sheet Name</label>
                <input type="text" name="name" required placeholder="e.g., FloorPlan">
            </div>
            <div class="form-group">
                <label>PDF File</label>
                <input type="file" name="pdf_file" accept=".pdf" required>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" class="btn" style="background: #6c757d;" onclick="hideUploadModal()">Cancel</button>
                <button type="submit" class="btn btn-success">Upload</button>
            </div>
        </form>
    </div>
</div>

<!-- Import CSV Modal (Two-step) -->
<div id="importModal" class="modal">
    <div class="modal-content">
        <h2 style="margin-bottom: 1rem;">Import Assets from CSV</h2>

        <!-- Step 1: File Selection -->
        <div id="import-step-1">
            <p class="text-muted" style="margin-bottom: 1rem;">
                Select a CSV file, then map its columns to the required fields.
            </p>
            <div class="form-group">
                <label>CSV File</label>
                <input type="file" id="import-csv-file" accept=".csv" required>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" class="btn" style="background: #6c757d;" onclick="hideImportModal()">Cancel</button>
                <button type="button" class="btn btn-success" onclick="importStepNext()">Next</button>
            </div>
        </div>

        <!-- Step 2: Column Mapping -->
        <div id="import-step-2" style="display: none;">
            <p class="text-muted" style="margin-bottom: 0.75rem;">
                Map CSV columns to the required fields. Auto-detected where possible.
            </p>
            <div id="import-csv-preview" style="margin-bottom: 0.75rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; font-size: 0.85rem; max-height: 60px; overflow-y: auto;"></div>
            <div class="form-group">
                <label>Asset ID <span style="color: #dc3545;">*</span></label>
                <select id="map-asset-id" style="width: 100%; padding: 0.4rem; border: 1px solid #ddd; border-radius: 4px;">
                </select>
            </div>
            <div class="form-group">
                <label>Asset Type <span style="color: #dc3545;">*</span></label>
                <div style="margin-bottom: 0.4rem;">
                    <label style="margin-right: 1rem; font-weight: normal; font-size: 0.85rem;">
                        <input type="radio" name="asset-type-mode" value="column" checked
                               onchange="toggleAssetTypeMode()"> From CSV column
                    </label>
                    <label style="font-weight: normal; font-size: 0.85rem;">
                        <input type="radio" name="asset-type-mode" value="fixed"
                               onchange="toggleAssetTypeMode()"> Fixed type
                    </label>
                </div>
                <select id="map-asset-type" style="width: 100%; padding: 0.4rem; border: 1px solid #ddd; border-radius: 4px;">
                </select>
                <select id="fixed-asset-type" style="width: 100%; padding: 0.4rem; border: 1px solid #ddd; border-radius: 4px; display: none;">
                    <option value="TN Intersection">TN Intersection</option>
                    <option value="VSL">VSL</option>
                    <option value="CCTV">CCTV</option>
                </select>
            </div>
            <div class="form-group">
                <label>X Coordinate <span style="color: #dc3545;">*</span></label>
                <select id="map-x" style="width: 100%; padding: 0.4rem; border: 1px solid #ddd; border-radius: 4px;">
                </select>
            </div>
            <div class="form-group">
                <label>Y Coordinate <span style="color: #dc3545;">*</span></label>
                <select id="map-y" style="width: 100%; padding: 0.4rem; border: 1px solid #ddd; border-radius: 4px;">
                </select>
            </div>
            <div class="form-group">
                <label>Name (optional)</label>
                <select id="map-name" style="width: 100%; padding: 0.4rem; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">-- None --</option>
                </select>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" class="btn" style="background: #6c757d;" onclick="importStepBack()">Back</button>
                <button type="button" class="btn btn-success" onclick="importWithMapping()">Import</button>
            </div>
        </div>
    </div>
</div>

<!-- Calibration Modal -->
<div id="calibrateModal" class="modal">
    <div class="modal-content">
        <h2 style="margin-bottom: 1rem;">Set Scale</h2>
        <p class="text-muted" style="margin-bottom: 1rem;">
            Enter the real-world distance between the two points you clicked.
        </p>
        <div class="form-group">
            <label>Pixel Distance (measured)</label>
            <input type="number" id="pixel-distance" readonly>
        </div>
        <div class="form-group">
            <label>Real Distance (meters)</label>
            <input type="number" id="real-distance" step="0.1" required>
        </div>
        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button type="button" class="btn" style="background: #6c757d;" onclick="hideCalibrateModal()">Cancel</button>
            <button type="button" class="btn btn-success" onclick="applyCalibration()">Apply</button>
        </div>
    </div>
</div>

{% csrf_token %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<script>
    const PROJECT_ID = {{ project.pk }};
    const PROJECT_DATA = {
        pixels_per_meter: {{ project.pixels_per_meter }},
        scale_calibrated: {{ project.scale_calibrated|yesno:"true,false" }},
        coord_unit: '{{ project.coord_unit|escapejs }}',
        origin_x: {{ project.origin_x }},
        origin_y: {{ project.origin_y }},
        canvas_rotation: {{ project.canvas_rotation }},
        asset_rotation: {{ project.asset_rotation }},
        ref_asset_id: '{{ project.ref_asset_id|escapejs }}',
        ref_pixel_x: {{ project.ref_pixel_x }},
        ref_pixel_y: {{ project.ref_pixel_y }}
    };
</script>
<script src="{% static 'js/canvas_editor.js' %}"></script>
{% endblock %}
