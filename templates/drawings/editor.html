{% extends 'base.html' %}
{% load static %}

{% block title %}Editor - {{ project.name }}{% endblock %}

{% block extra_css %}
<style>
    .editor-container {
        display: flex;
        height: calc(100vh - 60px);
    }

    /* Left Sidebar - Tools */
    .sidebar-left {
        width: 250px;
        background: white;
        border-right: 1px solid #ddd;
        padding: 1rem;
        overflow-y: auto;
    }

    .tool-section {
        margin-bottom: 1.5rem;
    }

    .tool-section h4 {
        font-size: 0.85rem;
        text-transform: uppercase;
        color: #6c757d;
        margin-bottom: 0.75rem;
        letter-spacing: 0.5px;
    }

    .tool-btn {
        display: block;
        width: 100%;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        background: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        text-align: left;
        transition: all 0.2s;
    }

    .tool-btn:hover {
        background: #e9ecef;
    }

    .tool-btn.active {
        background: #3498db;
        color: white;
        border-color: #3498db;
    }

    /* Main Canvas Area */
    .canvas-area {
        flex: 1;
        background: #e0e0e0;
        position: relative;
        overflow: hidden;
    }

    #canvas-container {
        width: 100%;
        height: 100%;
        cursor: grab;
    }

    #canvas-container.dragging {
        cursor: grabbing;
    }

    /* Right Sidebar - Properties */
    .sidebar-right {
        width: 300px;
        background: white;
        border-left: 1px solid #ddd;
        padding: 1rem;
        overflow-y: auto;
    }

    .property-group {
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #eee;
    }

    .property-group label {
        display: block;
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }

    .property-group input {
        width: 100%;
        padding: 0.4rem;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    /* Bottom Toolbar */
    .bottom-toolbar {
        position: absolute;
        bottom: 1rem;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .zoom-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .zoom-controls button {
        width: 30px;
        height: 30px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
    }

    .zoom-controls button:hover {
        background: #f8f9fa;
    }

    /* Sheet Layers Panel */
    .layer-item {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 4px;
        margin-bottom: 0.5rem;
        cursor: pointer;
    }

    .layer-item:hover {
        background: #e9ecef;
    }

    .layer-item.selected {
        background: #d4edda;
        border: 1px solid #28a745;
    }

    .layer-visibility {
        margin-right: 0.5rem;
    }

    /* Asset List */
    .asset-item {
        padding: 0.5rem;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .asset-item:hover {
        background: #f8f9fa;
    }

    .asset-item.adjusted {
        background: #fff3cd;
    }

    .coordinates {
        font-size: 0.75rem;
        color: #6c757d;
    }

    /* Status bar */
    .status-bar {
        position: absolute;
        top: 1rem;
        left: 260px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        font-size: 0.85rem;
    }

    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
    }

    .modal-content {
        background: white;
        max-width: 500px;
        margin: 100px auto;
        padding: 2rem;
        border-radius: 8px;
    }

    /* Tabs */
    .tabs {
        display: flex;
        border-bottom: 1px solid #ddd;
        margin-bottom: 1rem;
    }

    .tab {
        padding: 0.5rem 1rem;
        cursor: pointer;
        border-bottom: 2px solid transparent;
    }

    .tab.active {
        border-bottom-color: #3498db;
        color: #3498db;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="editor-container">
    <!-- Left Sidebar - Tools -->
    <div class="sidebar-left">
        <div class="tool-section">
            <h4>Mode</h4>
            <button class="tool-btn active" data-mode="pan" onclick="setMode('pan')">
                ‚úã Pan & Zoom
            </button>
            <button class="tool-btn" data-mode="select" onclick="setMode('select')">
                ‚û§ Select
            </button>
            <button class="tool-btn" data-mode="crop" onclick="setMode('crop')">
                ‚úÇ Cut Line
            </button>
            <button class="tool-btn" onclick="flipSelectedSheetCut()" style="font-size: 0.85em;">
                ‚ü≤ Flip Cut Side
            </button>
            <button class="tool-btn" onclick="clearSelectedSheetCut()" style="font-size: 0.85em;">
                ‚Ü© Clear Cut
            </button>
            <button class="tool-btn" data-mode="split" onclick="setMode('split')">
                ‚´Ω Split Sheet
            </button>
            <button class="tool-btn" data-mode="calibrate" onclick="setMode('calibrate')">
                üìè Calibrate Scale
            </button>
            <button class="tool-btn" data-mode="origin" onclick="setMode('origin')">
                ‚äï Set Origin
            </button>
        </div>

        <div class="tool-section">
            <h4>View Rotation</h4>
            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                <button class="tool-btn" style="flex: 1; text-align: center;" onclick="rotateViewportBy(-90)">-90</button>
                <button class="tool-btn" style="flex: 1; text-align: center;" onclick="rotateViewportBy(-15)">-15</button>
                <button class="tool-btn" style="flex: 1; text-align: center;" onclick="rotateViewportBy(15)">+15</button>
                <button class="tool-btn" style="flex: 1; text-align: center;" onclick="rotateViewportBy(90)">+90</button>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <input type="number" id="viewport-rotation" value="0" step="1" style="flex: 1; padding: 0.4rem; border: 1px solid #ddd; border-radius: 4px;" onchange="setViewportRotation(parseFloat(this.value) || 0)">
                <span style="font-size: 0.85rem; color: #6c757d;">deg</span>
                <button class="tool-btn" style="width: auto; margin: 0; padding: 0.4rem 0.75rem;" onclick="setViewportRotation(0)">Reset</button>
            </div>
        </div>

        <div class="tool-section">
            <h4>Sheets</h4>
            <div id="sheet-layers"></div>
            <button class="btn" style="width: 100%; margin-top: 0.5rem;" onclick="showUploadModal()">
                + Add Sheet
            </button>
        </div>

        <div class="tool-section">
            <h4>Assets</h4>
            <button class="btn" style="width: 100%;" onclick="showImportModal()">
                üì• Import CSV
            </button>
        </div>

        <div class="tool-section">
            <h4>Export</h4>
            <button class="btn btn-success" style="width: 100%;" onclick="exportProject()">
                üì§ Export PDFs
            </button>
            <button class="btn" style="width: 100%; margin-top: 0.5rem;" onclick="downloadReport()">
                üìä Adjustment Report
            </button>
        </div>
    </div>

    <!-- Main Canvas Area -->
    <div class="canvas-area">
        <div id="canvas-container"></div>

        <div class="status-bar" id="status-bar">
            Mode: <span id="current-mode">Pan</span> |
            Zoom: <span id="zoom-level">100</span>% |
            Rotation: <span id="rotation-level">0</span>¬∞ |
            Position: <span id="cursor-position">0, 0</span>
        </div>

        <div class="bottom-toolbar">
            <div class="zoom-controls">
                <button onclick="zoomOut()">‚àí</button>
                <span id="zoom-display">100%</span>
                <button onclick="zoomIn()">+</button>
                <button onclick="zoomFit()">Fit</button>
            </div>
            <button class="btn" onclick="resetView()">Reset View</button>
        </div>
    </div>

    <!-- Right Sidebar - Properties -->
    <div class="sidebar-right">
        <div class="tabs">
            <div class="tab active" data-tab="properties" onclick="showTab('properties')">Properties</div>
            <div class="tab" data-tab="assets" onclick="showTab('assets')">Assets</div>
        </div>

        <div id="properties-tab" class="tab-content active">
            <div id="no-selection" style="color: #6c757d; text-align: center; padding: 2rem;">
                Select a sheet or asset to view properties
            </div>

            <div id="sheet-properties" style="display: none;">
                <h4 style="margin-bottom: 1rem;">Sheet Properties</h4>
                <div class="property-group">
                    <label>Name</label>
                    <input type="text" id="sheet-name" onchange="updateSheetProperty('name', this.value)">
                </div>
                <div class="property-group">
                    <label>Offset X (px)</label>
                    <input type="number" id="sheet-offset-x" onchange="updateSheetProperty('offset_x', this.value)">
                </div>
                <div class="property-group">
                    <label>Offset Y (px)</label>
                    <input type="number" id="sheet-offset-y" onchange="updateSheetProperty('offset_y', this.value)">
                </div>
                <div class="property-group">
                    <label>Rotation (deg)</label>
                    <input type="number" id="sheet-rotation" onchange="updateSheetProperty('rotation', this.value)">
                </div>
                <div class="property-group">
                    <label>Z-Index (layer order)</label>
                    <input type="number" id="sheet-zindex" onchange="updateSheetProperty('z_index', this.value)">
                </div>
                <button class="btn" style="width: 100%; margin-top: 1rem; background: #dc3545; color: white;" onclick="deleteSelectedSheet()">
                    Delete Sheet
                </button>
            </div>

            <div id="asset-properties" style="display: none;">
                <h4 style="margin-bottom: 1rem;">Asset Properties</h4>
                <div class="property-group">
                    <label>Asset ID</label>
                    <input type="text" id="asset-id" readonly>
                </div>
                <div class="property-group">
                    <label>Name</label>
                    <input type="text" id="asset-name" readonly>
                </div>
                <div class="property-group">
                    <label>Original X (m)</label>
                    <input type="number" id="asset-orig-x" readonly>
                </div>
                <div class="property-group">
                    <label>Original Y (m)</label>
                    <input type="number" id="asset-orig-y" readonly>
                </div>
                <div class="property-group">
                    <label>Adjusted X (m)</label>
                    <input type="number" id="asset-adj-x" step="0.01" onchange="updateAssetPosition()">
                </div>
                <div class="property-group">
                    <label>Adjusted Y (m)</label>
                    <input type="number" id="asset-adj-y" step="0.01" onchange="updateAssetPosition()">
                </div>
                <div class="property-group">
                    <label>Notes</label>
                    <textarea id="asset-notes" rows="2"></textarea>
                </div>
                <button class="btn btn-success" style="width: 100%;" onclick="saveAssetAdjustment()">
                    Save Adjustment
                </button>
            </div>
        </div>

        <div id="assets-tab" class="tab-content">
            <div style="margin-bottom: 1rem;">
                <input type="text" id="asset-search" placeholder="Search assets..." style="width: 100%;">
            </div>
            <div id="asset-list" style="max-height: 500px; overflow-y: auto;"></div>
        </div>
    </div>
</div>

<!-- Upload Sheet Modal -->
<div id="uploadModal" class="modal">
    <div class="modal-content">
        <h2 style="margin-bottom: 1rem;">Upload PDF Sheet</h2>
        <p class="text-muted" style="margin-bottom: 1rem; font-size: 0.9rem;">
            Multi-page PDFs will automatically create separate sheets for each page,<br>
            named sequentially (e.g., name-01, name-02, ...).
        </p>
        <form id="uploadForm" enctype="multipart/form-data">
            <div class="form-group">
                <label>Sheet Name</label>
                <input type="text" name="name" required placeholder="e.g., FloorPlan">
            </div>
            <div class="form-group">
                <label>PDF File</label>
                <input type="file" name="pdf_file" accept=".pdf" required>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" class="btn" style="background: #6c757d;" onclick="hideUploadModal()">Cancel</button>
                <button type="submit" class="btn btn-success">Upload</button>
            </div>
        </form>
    </div>
</div>

<!-- Import CSV Modal -->
<div id="importModal" class="modal">
    <div class="modal-content">
        <h2 style="margin-bottom: 1rem;">Import Assets from CSV</h2>
        <p class="text-muted" style="margin-bottom: 1rem;">
            Required columns: asset_id, asset_type, x, y<br>
            Optional: name, description, and any metadata
        </p>
        <form id="importForm" enctype="multipart/form-data">
            <div class="form-group">
                <label>CSV File</label>
                <input type="file" name="file" accept=".csv" required>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" class="btn" style="background: #6c757d;" onclick="hideImportModal()">Cancel</button>
                <button type="submit" class="btn btn-success">Import</button>
            </div>
        </form>
    </div>
</div>

<!-- Calibration Modal -->
<div id="calibrateModal" class="modal">
    <div class="modal-content">
        <h2 style="margin-bottom: 1rem;">Set Scale</h2>
        <p class="text-muted" style="margin-bottom: 1rem;">
            Enter the real-world distance between the two points you clicked.
        </p>
        <div class="form-group">
            <label>Pixel Distance (measured)</label>
            <input type="number" id="pixel-distance" readonly>
        </div>
        <div class="form-group">
            <label>Real Distance (meters)</label>
            <input type="number" id="real-distance" step="0.1" required>
        </div>
        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button type="button" class="btn" style="background: #6c757d;" onclick="hideCalibrateModal()">Cancel</button>
            <button type="button" class="btn btn-success" onclick="applyCalibration()">Apply</button>
        </div>
    </div>
</div>

{% csrf_token %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<script>
    const PROJECT_ID = {{ project.pk }};
    const PROJECT_DATA = {
        pixels_per_meter: {{ project.pixels_per_meter }},
        origin_x: {{ project.origin_x }},
        origin_y: {{ project.origin_y }},
        canvas_rotation: {{ project.canvas_rotation }}
    };
</script>
<script src="{% static 'js/canvas_editor.js' %}"></script>
{% endblock %}
